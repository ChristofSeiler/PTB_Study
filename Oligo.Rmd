---
title: "Oligo"
author: Christof Seiler
date: November, 2016
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Goal

1. Load and normalize data using ``oligo``
2. Differential analysis using ``limma``

## Workflow

## Install Packages

Install necessary packages from bioconductor repository. Run this code only once to install packages.

```{r eval=FALSE}
source("https://bioconductor.org/biocLite.R")
biocLite("oligo")
biocLite("limma")
#biocLite("AffyCompatible")
biocLite("hta20sttranscriptcluster.db")
install.packages(c("xml2","ggfortify","magrittr","ff","foreach","doMC","statmod"))
```

Load packages.

```{r}
#library(ff)
#library(foreach)
#library(doMC)
#n_cores = as.integer(Sys.getenv("SLURM_NTASKS"))
#n_cores
#registerDoMC(n_cores)
library(oligo)
library(limma)
#library(AffyCompatible)
library(xml2)
library(ggfortify)
library(magrittr)
library(hta20sttranscriptcluster.db)
library(statmod)
```

## Import Data

Read sample phenotype data from ARR files (which are xml files) and extract information about experimental design. 

```{r}
file_names_arr = list.files("./",pattern = "ARR")
sample_table = sapply(file_names_arr,function(file_name) {
  xml_file = read_xml(file_name)
  # extract array name
  items = xml_find_all(xml_file, ".//PhysicalArray")
  array_name = xml_attrs(items[[1]])["ArrayName"]
  # extract conditions
  items = xml_find_all(xml_file, ".//UserAttribute")
  cond = c(xml_text(items),array_name)
  names(cond) = c(xml_attrs(items[[1]])["Name"],
                  xml_attrs(items[[2]])["Name"],
                  "array_name")
  cond
}) %>% t %>% data.frame
head(sample_table)
```

Then load Affymetrix CEL files. At this stage, Bioconductor will automatically download the necessary annotation packages and install them for us. 

```{r}
#celFiles = list.celfiles("./", full.names=TRUE)
pd = as(sample_table, "AnnotatedDataFrame")
cef_file_names = sapply(rownames(sample_table),function(file_name) {
  length_without_exp = nchar(file_name)-4
  paste0(".//",substr(file_name,0,length_without_exp),"_(HTA-2_0).CEL")
})
rawData = read.celfiles(cef_file_names,phenoData = pd,sampleNames = rownames(sample_table))
rawData
```

This is the downloaded annotation package:

```{r}
pd.hta.2.0
```

Let's have a first look at the data. These are the samples:

```{r}
slotNames(rawData)
sampleNames(rawData)
```

## Quality Control

MA plots on the first three samples.

```{r}
MAplot(rawData[, 1:3], pairs=TRUE)
```

Accessing probe sequences.

```{r}
pmSeq = pmSequence(rawData)
head(pmSeq)
```

The dependence of intensity on probe sequence is a well established fact on the microarray literature.

```{r}
#pmsLog2 = log2(pm(rawData))
#coefs = getAffinitySplineCoefficients(pmsLog2, pmSeq)
# TODO: We executing above command, we get the following error:
# Error in model.frame.default(formula = intensities ~ design, drop.unused.levels = TRUE) : 
#  variable lengths differ (found for 'design')
```

Probe level models.

```{r}
#fit1 = fitProbeLevelModel(rawData)
# TODO: Some plotting
```

## Preprocessing

Background subtraction, normalization and summarization using median-polish.

```{r}
eset = rma(rawData)
class(eset)
show(eset)
exprs(eset)[1:10, 1:2]
save(eset,file = "eset.Rdata")
```

PCA plot of normalized expressions.

```{r}
res_pca = prcomp(t(exprs(eset)),scale. = FALSE)
screeplot(res_pca)
autoplot(res_pca, data = sample_table, colour = 'Infection', shape = 'Case.Control', size = 3)
# make array names shorter for plotting
short_name = as.character(sample_table$array_name)
short_name = gsub(x = short_name,pattern = "Nicholas Bayless_",replacement = "")
short_name = gsub(x = short_name,pattern = "_\\(HTA-2_0\\)",replacement = "")
rownames(sample_table) = short_name
autoplot(res_pca, data = data.frame(sample_table,short_name), 
         shape = FALSE, label = TRUE, label.size = 3)
```

## Differential Expression Analyses - Two Factors

Use ``limma`` for linear models to assess difference in expression between the two groups.

```{r}
array_name = eset[["array_name"]]
# find paired samples
sample_table_ratio = read.csv("sample_table_ratio.csv")
sample_table_ratio$Mock = as.character(sample_table_ratio$Mock)
sample_table_ratio$H1N1 = as.character(sample_table_ratio$H1N1)
mock_ids = sapply(sample_table_ratio$Mock,function(mock_name) which(mock_name == array_name))
h1n1_ids = sapply(sample_table_ratio$H1N1,function(h1n1_name) which(h1n1_name == array_name))
# encode paired samples
subject = rep(NA,length(array_name))
for(id in 1:length(mock_ids)) {
  subject[c(mock_ids[id],h1n1_ids[id])] = id
}
# combine
targets = data.frame(array_name,
                     subject=as.factor(subject),
                     condition=eset[["Infection"]],
                     treatment=eset[["Case.Control"]])
targets$array_name = as.character(targets$array_name)
levels(targets$condition)[levels(targets$condition)=="Control"] = "Term"
levels(targets$condition)[levels(targets$condition)=="Case"] = "Preterm"
rownames(targets) = 1:nrow(targets)
# exclude sample that are not paired
paired_ids = which(!is.na(targets$subject))
targets = targets[paired_ids,]
exprs(eset) = exprs(eset)[,paired_ids]
phenoData(eset) = as(targets, "AnnotatedDataFrame")
# design
combo = factor(paste(targets$condition,targets$treatment,sep="_"))
design = model.matrix(~ 0 + combo)
colnames(design) = levels(combo)
```

Estimate the correlation between measurements made on the same subject.

From [limma vignette (page 50)](https://www.bioconductor.org/packages/devel/bioc/vignettes/limma/inst/doc/usersguide.pdf):
"This experiment has two levels of variability. First, there is the variation from person to person, which we call the between-subject strata. Then there is the variability of repeat measurements made on the same subject, the within-subject strata. The between-subject variation is always expected to be larger than within-subject, because the latter is adjusted for baseline differences between the subjects. Here the comparison between tissues can be made within subjects, and hence should be more precise than the comparison between diseased and normal, which must be made between subjects."

```{r}
corfit = duplicateCorrelation(eset,design,block=targets$subject)
```

Then this inter-subject correlation is input into the linear model fit.

```{r}
fit = lmFit(eset,design,block=targets$subject,correlation=corfit$consensus)
```

Now we can make any comparisons between the experimental conditions.

```{r}
cm = makeContrasts(
  Preterm_vs_Term_for_H1N1 = Preterm_H1N1-Term_H1N1,
  Preterm_vs_Term_for_Mock = Preterm_Mock-Term_Mock,
  H1N1_vs_Mock_for_Preterm = Preterm_H1N1-Preterm_Mock,
  H1N1_vs_Mock_for_Term = Term_H1N1-Term_Mock,
  levels=design)
```

Then compute these contrasts and moderated t-tests.

```{r}
fit = contrasts.fit(fit, cm)
fit = eBayes(fit)
```

The topTable command provides us a way of ranking genes for further evaluation. In the case below, we adjust for multiple testing by FDR. Save results in a list of tables.

```{r}
gene_table_list = lapply(colnames(cm),function(cm_name) {
  gene_table = topTable(fit, coef=cm_name, adjust="BH", number = nrow(fit))
  print(head(gene_table))
  gene_table
})
```

Volcano plots for quality control.

```{r}
for(cm_name in colnames(cm)) {
  cat(cm_name,"\n")
  volcanoplot(fit,coef = cm_name,highlight = 10)
}
```

Map between manufacturer identifiers and gene symbols.

```{r}
e2s = toTable(hta20sttranscriptclusterSYMBOL)
map_gene_symbol = function(gene_table) {
  prob_ids = rownames(gene_table)
  symbol = sapply(prob_ids,function(prob_id) {
    matching_symbol = e2s$symbol[prob_id==e2s$probe_id]
    if(length(matching_symbol)==0) matching_symbol = "No_Symbol_Found"
    matching_symbol
  }) %>% unlist
  gene_table = cbind(gene_table,symbol=symbol,stringsAsFactors=FALSE)
  print(head(gene_table))
  gene_table  
}
gene_table_list = lapply(gene_table_list,map_gene_symbol)
```

This is the fraction of gene transcripts that didn't map to any gene symbols.

```{r}
for(i in 1:length(gene_table_list)) {
  cat(colnames(cm)[i],"\n",
    "fraction of symbols not found:",
    mean(gene_table_list[[i]]$symbol=="No_Symbol_Found"),"\n",
    "number of significant genes below FDR of 0.05:",
    sum(gene_table_list[[i]]$adj.P.Val < 0.05),
    "\n")
}
```

## Differential Expression Analyses - Paired

To calculate the ratio, we subtract the log expression counts between Mock from H1N1 paired samples.

```{r}
pairs = sapply(levels(eset[["subject"]]),function(id) {
  mock_id = which(eset[["subject"]] == id & eset[["treatment"]] == "Mock")
  h1n1_id = which(eset[["subject"]] == id & eset[["treatment"]] == "H1N1")
  condition = as.character(eset[["condition"]][mock_id])
  c(mock_id=mock_id,h1n1_id=h1n1_id,condition=condition)
}) %>% t %>% data.frame
pairs$condition = relevel(pairs$condition,"Term")
ratio = exprs(eset)[,pairs$h1n1_id] - exprs(eset)[,pairs$mock_id]
exprs(eset) = ratio
phenoData(eset) = as(pairs, "AnnotatedDataFrame")
# linear model fit
condition = pairs$condition
design = model.matrix(~ condition)
fit = lmFit(eset, design)
fit = eBayes(fit)
paired_gene_table = topTable(fit, coef="conditionPreterm", adjust="BH", number = nrow(fit))
paired_gene_table = map_gene_symbol(paired_gene_table)
head(paired_gene_table)
mean(paired_gene_table$symbol=="No_Symbol_Found")
sum(paired_gene_table$adj.P.Val < 0.05)
```

## Export Results

Write to text file.

```{r}
write.csv(targets,file = "targets.csv")
for(i in 1:length(gene_table_list)) {
  file_name_results = paste0(colnames(cm)[i],"_results.csv")
  cat("writting:",file_name_results,"\n")
  write.csv(gene_table_list[[i]],file = file_name_results)
}
file_name_results = "Preterm_vs_Term_for_Ratio_H1N1_Mock_results.csv"
cat("writting:",file_name_results)
write.csv(paired_gene_table,file = file_name_results)
```

## Session Info

```{r session_info}
sessionInfo()
```
