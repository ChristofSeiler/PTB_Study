---
title: "Time to Delivery Analysis on Follow-Up qPCR Data"
author:
  name: Christof Seiler
  affiliation: Department of Statistics, Stanford University
output:
  BiocStyle::html_document:
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Goal

Analyze data from qPCR experiments.

# Prerequisites

Install necessary packages from bioconductor repository. Run this code only once to install packages.

```{r install_packages, warning=FALSE, message=FALSE}
pkgs_needed = c("ggplot2","magrittr","readr","dplyr",
                "readxl","stringr","tidyr","car",
                "interactions","ggthemes","cowplot",
                "MASS")
letsinstall = setdiff(pkgs_needed, installed.packages()) 
if (length(letsinstall) > 0) {
  source("http://bioconductor.org/biocLite.R")
  biocLite(letsinstall)
}
```

Load packages.

```{r load_packages, warning=FALSE, message=FALSE}
library("magrittr")
library("ggplot2")
library("readr")
library("dplyr")
library("readxl")
library("stringr")
library("tidyr")
library("MASS")
library("interactions")
library("ggthemes")
library("cowplot")
library("car")
theme_set(theme_few())
scale_colour_discrete = function(...) scale_colour_few()
```

# Import Data

Read, merge, and tidy sample tables.

```{r read_sample_table}
sample_info_filename = "MSS Case_Control Matches (Masked)_new_matched.xlsx"
data_filename = "PTB Raw qPCR data.xlsx"
new_matched = read_excel(sample_info_filename)
new_matched %<>% mutate(time_to_delivery_calc = 
                          gestage_enroll - gestage_delivery)
qpcr_data = read_excel(data_filename)
qpcr_data$SampleID %<>% as.character
qpcr_data %<>% dplyr::left_join(new_matched,by = "SampleID", 
                                suffix = c("", "2"))
qpcr_data %<>% dplyr::select(sample_id = SampleID,
                             ptb_case,
                             time_to_delivery = time_to_delivery_calc,
                             gestage_delivery,
                             RGS13_baseline,
                             IFNL_baseline,
                             IFNL_flu)
qpcr_data %<>% gather(RGS13_baseline, IFNL_baseline, IFNL_flu, 
                      key = "key", value = "expr")
qpcr_data %<>% mutate(
  treatment = if_else(condition = str_detect(qpcr_data$key, "baseline"),
                      true = "mock",
                      false = "H1N1"))
qpcr_data %<>% mutate(
  gene_name = sapply(strsplit(qpcr_data$key,split = "_"),
                     function(str) str[[1]]))
qpcr_data %<>% dplyr::select(-key)
qpcr_data$treatment = factor(qpcr_data$treatment,levels = c("mock","H1N1"))
qpcr_data %<>% rename(ptb = ptb_case)
qpcr_data
```

# Fit Model

## RGS13

Subset to RGS13.

```{r subset_RGS13}
qpcr_data_RGS13 = qpcr_data %>% dplyr::filter(gene_name == "RGS13")
```

Plotting to see possible outliers.

```{r plotting_RGS13,fig.width=4,fig.height=4}
ggplot(qpcr_data_RGS13,aes(expr)) + 
  geom_histogram(bins = 30) + 
  facet_wrap(~ptb) +
  ggtitle("RGS13")
ggplot(qpcr_data_RGS13,aes(x = time_to_delivery, y = expr, 
                           color = treatment)) +
  geom_smooth(method = lm, se = FALSE) +
  geom_point() +
  geom_text(aes(label = ifelse(expr > quantile(expr, probs = 0.95), 
                               sample_id,"")), hjust = 0, vjust = 0) +
  ggtitle("RGS13")
ggplot(qpcr_data_RGS13,aes(x = gestage_delivery, y = expr, 
                           color = treatment)) +
  geom_smooth(method = lm, se = FALSE) +
  geom_point() +
  geom_text(aes(label = ifelse(expr > quantile(expr, probs = 0.95), 
                               sample_id,"")), hjust = 0, vjust = 0) +
  ggtitle("RGS13")
```

Fit model for `RGS13`.

```{r fit_model_RGS13}
lm_fit = lm(expr ~ time_to_delivery + gestage_delivery, qpcr_data_RGS13)
summary(lm_fit)
```

Fit robust model using rank-based estimates of regression coefficients.

```{r fit_model_RGS13_rank}
lm_fit = rlm(expr ~ time_to_delivery + gestage_delivery, qpcr_data_RGS13)
summary(lm_fit)
```

Remove potential outlier and refit model to see if we still obtain a similar result.

```{r fit_model_RGS13_outlier}
qpcr_data_RGS13 %<>% dplyr::filter(sample_id != "16.2")
lm_fit = lm(expr ~ time_to_delivery + gestage_delivery, qpcr_data_RGS13)
summary(lm_fit)
```

Plot of fitted intercept and slope with `gestage_delivery` fixed at its mean value.

```{r fit_model_RGS13_outlier_plot, fig.width=4,fig.height=4}
coefs = coef(lm_fit)
gmine = ggplot(qpcr_data_RGS13, aes(x = time_to_delivery, y = expr, 
                                    color = treatment, shape = ptb)) + 
  geom_point(size = 2)
used_colors = unique(ggplot_build(gmine)$data[[1]]$colour)
mean_gestage = mean(qpcr_data_RGS13$gestage_delivery)
gmine + geom_abline(intercept = coefs["(Intercept)"] + 
                      mean_gestage*coefs["gestage_delivery"],
                    slope = coefs["time_to_delivery"],
                    color = used_colors[1], size = 1) + ggtitle("RGS13")
ggsave(filename = "time_to_delivery_RGS13.png",
       width = 4,height = 3,dpi = 600)
```

## IFNL

Subset to `IFNL`.

```{r subset_IFNL}
qpcr_data_IFNL = qpcr_data %>% dplyr::filter(gene_name == "IFNL")
```

Plotting to see possible outliers.

```{r plotting_IFNL,fig.width=4,fig.height=4}
ggplot(qpcr_data_IFNL,aes(expr)) + 
  geom_histogram(bins = 30) + 
  facet_wrap(~ptb) +
  ggtitle("IFNL")
ggplot(qpcr_data_IFNL,aes(x = time_to_delivery, y = expr, 
                          color = treatment)) +
  geom_smooth(method = lm, se = FALSE) +
  geom_point() +
  geom_text(aes(label = ifelse(expr > quantile(expr, probs = 0.95), 
                               sample_id,"")), hjust = 0, vjust = 0) +
  ggtitle("IFNL")
ggplot(qpcr_data_IFNL,aes(x = gestage_delivery, y = expr, 
                          color = treatment)) +
  geom_smooth(method = lm, se = FALSE) +
  geom_point() +
  geom_text(aes(label = ifelse(expr > quantile(expr, probs = 0.95), 
                               sample_id,"")), hjust = 0, vjust = 0) +
  ggtitle("IFNL")
```

Fit model for `IFNL`.

```{r fit_model_IFNL}
lm_fit = lm(expr ~ treatment*time_to_delivery + gestage_delivery,
            data = qpcr_data_IFNL)
summary(lm_fit)
```

Fit robust linear model fit and bootstrap resampling for confidence intervals and p-values.

```{r fit_model_rank, fig.height=8}
lm_fit_robust = rlm(expr ~ treatment*time_to_delivery + gestage_delivery, 
                    data = qpcr_data_IFNL, maxit = 200)
summary(lm_fit_robust)
# bootstrap confidence interval and p-value
set.seed(0xdada)
lm_fit_robust_boot = Boot(lm_fit_robust, R = 1999)
summary(lm_fit_robust_boot)
hist(lm_fit_robust_boot, legend="separate")
Confint(lm_fit_robust_boot, level = 0.95, type = "perc")
Confint(lm_fit_robust_boot, level = 0.95, type = "bca")
# p-value for stimulation x time to delivery interaction term
R = 1999
t_obsv = lm_fit_robust_boot$t0["treatmentH1N1:time_to_delivery"]
t_boot = lm_fit_robust_boot$t[,"treatmentH1N1:time_to_delivery"]-t_obsv
pvalue = (1 + sum(abs(t_boot) > abs(t_obsv))) / (R + 1)
pvalue
```

Refit linear model after removing possible outlier.

```{r fit_model_IFNL_outlier}
qpcr_data_IFNL_with_outlier = qpcr_data_IFNL
qpcr_data_IFNL %<>% dplyr::filter(sample_id != "1.1")
lm_fit = lm(expr ~ treatment*time_to_delivery + gestage_delivery, data = qpcr_data_IFNL)
summary(lm_fit)
```

More modern looking visualization using the `jtools` package.

```{r interact_plot, fig.width=4,fig.height=4}
gtimeto = interact_plot(lm_fit, pred = "time_to_delivery", 
                        modx = "treatment",
                        plot.points = TRUE, jitter = 0) + 
  ggtitle("IFNL")
gtimeto
interact_plot(lm_fit, pred = "gestage_delivery", modx = "treatment",
              plot.points = TRUE, jitter = 0) + 
  ggtitle("IFNL")
```

Plot interaction using using only `ggplot`. The function `interact_plot` plots intercepts and slopes with fixed `gestage_delivery` at their mean values.

```{r my_interact_plot, fig.width=8,fig.height=4,fig.wide=TRUE}
my_interaction_plot = function(lm_fit, qpcr_data_IFNL) {
  coefs = coef(lm_fit)
  gmine = ggplot(qpcr_data_IFNL, aes(x = time_to_delivery, y = expr, 
                                     color = treatment, shape = ptb)) + 
    geom_point(size = 2)
  used_colors = unique(ggplot_build(gmine)$data[[1]]$colour)
  mean_gestage_delivery = mean(qpcr_data_IFNL$gestage_delivery)
  intercept = coefs["(Intercept)"] + 
    coefs["gestage_delivery"]*mean_gestage_delivery
  #h1n1 = coefs["treatmentH1N1:gestage_delivery"]*mean_gestage_delivery
  #slope = coefs["time_to_delivery:gestage_delivery"]*mean_gestage_delivery
  gmine + 
    geom_abline(intercept = intercept,
                slope = coefs["time_to_delivery"], # slope + 
                color = used_colors[1], size = 1) +
    geom_abline(intercept = intercept + coefs["treatmentH1N1"], # h1n1 + 
                slope = coefs["time_to_delivery"] + # slope + 
                  coefs["treatmentH1N1:time_to_delivery"],
                color = used_colors[2], size = 1) +
    ggtitle("IFNL (without 1.1)")
}
gmine = my_interaction_plot(lm_fit, qpcr_data_IFNL)
plot_grid(gtimeto, gmine)
ggsave(gmine, filename = "interaction_time_to_delivery_IFNL.png",
       width = 4, height = 3, dpi = 600)
```

Compare to fit with outlier.

```{r with_outlier, fig.width=8,fig.height=4,fig.wide=TRUE}
lm_fit_with_outlier = lm(expr ~ treatment*time_to_delivery + gestage_delivery,
                         data = qpcr_data_IFNL_with_outlier)
gtimeto_with_outlier = interact_plot(lm_fit_with_outlier, pred = "time_to_delivery", 
              modx = "treatment",
              plot.points = TRUE, jitter = 0) + 
  ggtitle("IFNL")
gmine_with_outlier = my_interaction_plot(lm_fit_with_outlier, 
                                         qpcr_data_IFNL_with_outlier) + 
  ggtitle("IFNL")
plot_grid(gtimeto_with_outlier, gmine_with_outlier)
ggsave(gmine_with_outlier, 
       filename = "interaction_time_to_delivery_IFNL_with_outlier.png",
       width = 4, height = 3, dpi = 600)
```

Compare to robust fit with outlier.

```{r with_robust_fit, fig.width=4,fig.height=4,fig.wide=TRUE}
gmine_with_outlier_robust = my_interaction_plot(lm_fit_robust, 
                                                qpcr_data_IFNL_with_outlier) + 
  ggtitle("IFNL (robust fit)")
gmine_with_outlier_robust
ggsave(gmine_with_outlier_robust, 
       filename = "interaction_time_to_delivery_IFNL_robust_with_outlier.png",
       width = 4, height = 3, dpi = 600)
```

# Session Info {.unnumbered}

```{r session_info}
sessionInfo()
```
